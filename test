##############################################
#     HAProxy - Redis Cluster Proxy (secured)
#     Compatible Redis 8.2.2 + Celery
##############################################

global
    log /dev/log local0
    maxconn 4096
    user haproxy
    group haproxy
    daemon

defaults
    log global
    mode tcp
    timeout connect 5s
    timeout client  1m
    timeout server  1m
    option tcplog

# Frontend: point d'entrée unique
frontend redis_front
    bind *:7777
    default_backend redis_cluster

# Backend: tes 3 nœuds Redis
backend redis_cluster
    balance roundrobin
    option tcp-check
    tcp-check connect
    tcp-check send AUTH\ RedisClusterPass!\r\n
    tcp-check expect string +OK
    tcp-check send PING\r\n
    tcp-check expect string +PONG
    tcp-check send QUIT\r\n
    tcp-check expect string +OK

    server redis1 10.0.0.101:6379 check inter 3s rise 2 fall 2
    server redis2 10.0.0.102:6379 check inter 3s rise 2 fall 2
    server redis3 10.0.0.103:6379 check inter 3s rise 2 fall 2
