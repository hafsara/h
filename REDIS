Parfait Hafsa ğŸ‘
Je vois que ton playbook est dÃ©jÃ  **trÃ¨s bien structurÃ©** â€” tu as :

* une sÃ©paration claire entre `redis.conf.j2` / `sentinel.conf.j2`,
* des handlers pour redÃ©marrer les services,
* et une structure adaptÃ©e Ã  un dÃ©ploiement automatisÃ© (Ansible pro, bravo ğŸ’ª).

Je vais tâ€™indiquer **exactement les modifications Ã  faire** pour transformer ton playbook actuel en **architecture Redis + Sentinel HA**, compatible avec **Celery** â€” sans casser ta logique existante.

---

## ğŸ§© Objectif final

Sur **chaque serveur Redis** :

* 1 fichier `redis.conf`
* 1 fichier `sentinel.conf`
* 2 services distincts :

  * `redis_master.service` ou `redis_replica.service`
  * `redis_sentinel.service`

---

## âš™ï¸ Ã‰tape 1 â€” Structure `hosts.yml`

Tu es dÃ©jÃ  presque bonne :

```yaml
redis:
  hosts:
    eurvlii333435.xmp.net.intra:
      master: yes
      replica: no
    eurvlii333455.xmp.net.intra:
      master: no
      replica: yes
    eurvlii333906.xmp.net.intra:
      master: no
      replica: yes
```

âœ… garde exactement cette structure.
Câ€™est ce que tes templates utiliseront pour savoir qui configure quoi.

---

## âš™ï¸ Ã‰tape 2 â€” Adapter `redis.conf.j2`

Tu dois diffÃ©rencier master / replica :

```jinja
# redis.conf.j2
port 6379
bind 0.0.0.0
daemonize yes
protected-mode no
dir {{ app_dir }}/data
logfile {{ app_dir }}/logs/redis.log

requirepass {{ vault.redis.password }}
masterauth {{ vault.redis.password }}

{% if node.status == 'master' %}
# Master
{% else %}
# Replica
replicaof {{ hostvars[groups['redis'][0]]['ansible_host'] | default(groups['redis'][0]) }} 6379
{% endif %}
```

â¡ï¸ Le bloc `replicaof` pointe toujours vers ton **premier host (le master)**.

---

## âš™ï¸ Ã‰tape 3 â€” CrÃ©er `sentinel.conf.j2`

Ton template doit Ãªtre le mÃªme pour tous les nÅ“uds :

```jinja
port 26379
bind 0.0.0.0
daemonize yes
dir {{ app_dir }}/data
logfile {{ app_dir }}/logs/sentinel.log

sentinel monitor mymaster {{ hostvars[groups['redis'][0]]['ansible_host'] | default(groups['redis'][0]) }} 6379 2
sentinel auth-pass mymaster {{ vault.redis.password }}
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 10000
sentinel parallel-syncs mymaster 1
```

---

## âš™ï¸ Ã‰tape 4 â€” CrÃ©er un service `redis-sentinel.service.j2`

Ajoute un nouveau template :
`roles/redis/templates/redis-sentinel.service.j2`

```ini
[Unit]
Description=Redis Sentinel Service
After=network.target

[Service]
ExecStart={{ app_dir }}/bin/redis-sentinel {{ app_dir }}/conf/sentinel.conf
ExecStop=/bin/kill -s TERM $MAINPID
Restart=always
User={{ service_account }}

[Install]
WantedBy=multi-user.target
```

---

## âš™ï¸ Ã‰tape 5 â€” Modifier ton `configure.yml`

Tu as dÃ©jÃ  :

```yaml
- src: redis.conf.j2
- src: sentinel.conf.j2
```

Ajoute maintenant aussi :

```yaml
- src: redis-sentinel.service.j2
  dest: "/usr/lib/systemd/system/redis-sentinel.service"
  mode: "0644"
```

et ajoute dans la mÃªme tÃ¢che :

```yaml
- name: enable redis-sentinel service
  shell: |
    systemctl daemon-reload
    systemctl enable redis-sentinel
    systemctl restart redis-sentinel
  become: yes
```

---

## âš™ï¸ Ã‰tape 6 â€” Modifier tes handlers

Tu as actuellement :

```yaml
- name: restart redis master
  shell: sudo systemctl restart redis_master
```

Ajoute un handler pour le sentinel :

```yaml
- name: restart redis sentinel
  shell: sudo systemctl restart redis-sentinel
  become: yes
```

et notifie-le depuis `configure.yml` :

```yaml
notify:
  - restart redis {{ node.status }}
  - restart redis sentinel
```

---

## âš™ï¸ Ã‰tape 7 â€” VÃ©rification Ansible

Quand tu feras ton run :

```bash
ansible-playbook -i stg/hosts.yml redis.yml
```

Tu dois voir :

* CrÃ©ation de `/etc/systemd/system/redis-sentinel.service`
* Installation de `redis.conf` et `sentinel.conf` sur les 3 serveurs
* RedÃ©marrage de :

  * `redis_master` sur 1 serveur
  * `redis_replica` sur 2 serveurs
  * `redis-sentinel` sur les 3

---

## âœ… VÃ©rification manuelle

Sur chaque serveur :

```bash
systemctl status redis*
```

Doit montrer :

```
redis_master.service     active (running)
redis-sentinel.service   active (running)
```

et cÃ´tÃ© Redis CLI :

```bash
redis-cli -p 26379 info Sentinel | grep master
```

doit afficher ton `mymaster` avec un seul master et deux replicas.

---

## ğŸ’¡ RÃ©sumÃ© visuel

| Serveur          | Fichiers                  | Services actifs               |
| ---------------- | ------------------------- | ----------------------------- |
| redis1 (master)  | redis.conf, sentinel.conf | redis_master, redis-sentinel  |
| redis2 (replica) | redis.conf, sentinel.conf | redis_replica, redis-sentinel |
| redis3 (replica) | redis.conf, sentinel.conf | redis_replica, redis-sentinel |

---

Souhaites-tu que je te gÃ©nÃ¨re **les fichiers complets finaux (`redis.conf.j2`, `sentinel.conf.j2`, `redis-sentinel.service.j2`)** prÃªts Ã  coller dans ton `roles/redis/templates/` ?
